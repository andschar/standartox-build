---
title: "Etox-Base - A tool and data set in ecotoxicology [max. 110 words]"
author: "Andreas Scharmüller"
date: "August 29, 2018"
output:
  # bookdown::html_book:
  bookdown::pdf_document2:
  # bookdown::html_document2:
  # html_document:
bibliography: references-etox-base.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE}
# projectdir
prj = '/home/andreas/Documents/Projects/etox-base'

# packages
require(data.table)

# variables
datadir = file.path(prj, 'article/data') # in sub folder article
cachedir = file.path(prj, 'cache')
```

\newcommand{\etoxbase}{Etox-Base}
\newcommand{\epa}{EPA ECOTOX data base}
\newcommand{\app}{http://139.14.20.252:3838/etox-base-shiny/}

# Abstract [max. 170 words]

# Background & Summary (i.e. Introduction) [max 700 words]

A vast amount of chemical compounds such as pharmaceuticals, pesticides, synthetic hormones and many more are used all over the world with insufficient knowledge about possible adverse effects on the environment. In Europe alone some 100,000 compounds are estimated to be in current use, whereof 30,000 are produced in quantities larger than one ton per year. Thereof less than one percent are thoroughly tested [@breithaupt_costs_2006]. For substances that have been tested adverse effects could be detected. Pesticides for exmaple reduce macro-invertebrate biodiversity in streams [@beketov_pesticides_2013] and estrogenic-associated effects were found in fish [@vethaak_integrated_2005]. However for many substance groups, especially newly emerging ones authorative test results remain scarce or not hard to find. To overcome such knowledge paucities it is paramount to accumulate and distribute existing knowledge on possible adverse effects of substances widely. The ECOTOXicology knowledgebase (ECOTOX) created by U.S. Environmental Protection Agency (EPA) represents one such initiative. It collects ecotoxicological test data on on aquatic and terrestrial wildlife as well as plants and publishes it on a quarterly basis freely accessible on the web. By the time of writing it contained 919,123 test results, comprising 11,655 chemical compounds tested on 12,630 different species [@elonen_ecotoxicology_2018]. The ecotoxicological tests are collected without limitation and comprise all sorts of measured endpoints such as Effective Concentrations - EC50 values, No-observed effect concentratons NOEC or lowest observed effect concentraitons - LOEC. Likewise the data set contains many different effect measures such as mortality, intoxication, growth etc. and test durations ranging from seconds to weeks or even years. These test results can be used to derive toxicity risk thresholds. As ecotoxicological risk assessment often relies on national and international quality thresholds such as EU-Environmtal quality standards (EQS) or Regulatory Aceptable concentrations (RAC) in Germany. In order to make this data more widely accessible we created a tool that downloads every new version of the \epa{} and performs several quality checks, e.g. unit harmonization, and cleaning steps on it. In addition to the test parameters that are retrieved from the \epa{} we query compound and organism parameters from other open data bases to adress missing information such as compound solubility or organism habitat or regional ocurrence patterns. Subsequently the data is provided online via a web app where users can filter the data according to needed test parameters. Furthermore the user can choose between several aggregation methods to retrieve individual values per compound. Compounds are identified by their CAS-number as this is also the key identifier in the \epa{}. Optionally the data base can also be downloaded as a whole for local useage. This is the first approach that tries to handle large amounts of toxicity test data to derive meaningful information about the susceptability of organisms towards individual compounds by aggregating test results. Researchers relying on ecotoxicological test data will benefit from the \etoxbase{} due to concise representation ecotoxicological test data.


# Methods [no word limit]

The EPA releases \epa{} on a quarterly basis through their website. The software downloads each new version and rebuilds it locally in a PostgreSQL data base. A processing pipline of several R \cite{r_core_team_r_2017} scripts prepares the data for the tool. The tool itself is a R function that is executed by a user acessing the R shiny \citep{chang_shiny_2018} application. In the following the steps for processing the data are explained in more detail (PATH_TO_OVERVIEW) as well as the scripts that have been used for it (REFER_TO_SCRIPTS_TABLE).

## Downloading and preparing the data

The data is downloaded (bd_epa_download.R) and subsequently built into a PostgreSQL data base (bd_epa_postgres.R). Thereafter the data is imported into R for preparing it (da_epa1.R, da_epa2.R, da_epa3.R), by removing special characters type conversions, unit harmonizations and by reducing the columns. At the end the data is stored locally (epa3.rds, epa2_taxa.rds, epa2_chem.rds). Obtained CAS numbers and taxon names are then used to query other data bases for additional information on compounds and biota respectively. Compound information is retrieved from the Pubchem data base \citep{CITE_PUBCHEM} (qu_pc.R), from the Compendium of Pesticide Common Names \citep{CITE_AW} (qu_aw.R), from the Physprop data base \citep{CITE_PHYSPROP} (qu_pp.R), from EUROSTAT and the Chemspider data base \citep(CITE_CHEMSPIDER). These queries mostly rely on the webchem R-package \citep{szocs_webchem_2015-1}. Additional habitat and occurrence information for organisms is queried from the World Register of Marine Species (WORMS) \citep{WORMS} and from the Global Biodiversity Information Facility (GBIF) \citep{CITE_RGBIF} using the rgbif R-package. The acquired information is then merged (re_merge.R), variables are combined and created (re_combine.R), checked (re_checks_internal.R) and finally compiled in one final table (re_final.R) This table is then used in the application to perform search queries on. For a detailed overview of what information is collected see table (REFERNCE_TO_VARIABLE_TABLE)

## The Application
The application is accesible through \app{}



### functionalities

### 














# Supporting information


Tables:

(1) script-table
(2) varaiable-table


# OLD










Due to its size allowing for a more broad compound assessment.

Widely used endpoints are EC50s which determine the concentration where 50% of e.g. plant growth is inhibited, 50% of individuals have died etc. These can be realted to measured concnetrations by calculating Toxic Units (TUs) \@ref(eq:tu) [@schafer_effects_2011] [+other citations!!]. 

\begin{equation*}
TU = \frac{conc_i}{EC50}
(\#eq:tu)
\end{equation*}

Test results vary naturally 

Effects of chemical substances vary with time [@sanchez-bayo_simple_2009]. Therefore we propose to aggregate in a first step tests according to the tested compoud, the tested species and the test duration. Hereby if the number of tests is smaller or equal to two the minimum otherwise the median of the reported test concentrations is taken. Secondly this data can then be filtered \@ref(tab:table-filters) and aggregated by the user through the tool/app. Filters steps are applied before the aggregation. 

```{r table-filters, echo=FALSE}
epa_stats_l = readRDS(file.path(cachedir, 'epa_stats_l.rds'))

conc_type = epa_stats_l[['coty']]$conc_type
auth = c('Africa', 'Asia', 'Europe', 'North America', 'South America', 'Australia')
chem_type = c('metal', 'pesticide')

filter_chem = data.frame(filters = c('Concentration type', 'Chemical class', 'Authorization'),
                         options = c(paste0(conc_type, collapse = ', '),
                                     paste0(chem_type, collapse = ', '),
                                     paste0(auth, collapse = ', ')),
                         explanations = 'link')

habi = c('all', 'marine', 'brackish', 'freshwater', 'terrestrial')
conti = 'bla'

filter_taxa = data.frame(filters = c('Organism habitat', 'Continent'),
                         options = paste0(habi, collapse = ', '))

knitr::kable(filter_chem, caption = 'Chemical compound filter option')
knitr::kable(filter_taxa, caption = 'Taxa filter options')
```


Filters according to concentration type (AI - Active ingredient, F-Formulation)


However, due to the large number of tests it is not always trivial to determine single EC50 values for chemical substances. Therefore we propose a toolkit, data set that allows to choose between multiple aggregation methods.

Similar data bases exist and one prominent example is the Pesticide Property Data Base (PPDB) [citation!] which is operated by the university of Head



# Introduction IDEAS


checkout citation in [@koehler_wildlife_2013]: Rohr 2008  
"A field survey of the northern leopard
frog, Rana pipiens, revealed that atrazine pol-
lution and inorganic phosphate accounted for
74% of the variation in the abundance of trem-
atodes (62)."



"Currently, pesticide use is wide-spread in agriculture all over the world, but still only very few countries have established wildlife poisoning surveillance programs (2). As a result, many data on pesticides remain scattered and/or
not publicly available" [@kohler_wildlife_2013]

"bias towards domestic and lab models" [@kohler_wildlife_2013]

"Even though the banning of highly persistent or-
ganochlorines in developed countries has shifted
pesticide use toward a vast diversity of readily
biodegradable ingredients, the explosiveness of
organochlorines on a global scale cannot be ig-
nored." [@koehler_wildlife_2013]

-> half a milion tons in developing countries

"to date 120 endocrine disruptive chemcials are known" [@koehler_wildlife_2013] 
R. McKinlay, J. A. Plant, J. N. B. Bell, N. Voulvoulis,
Environ. Int. 34, 168–183 (2008). covering numerous classes

important effects: thyroid disruption



"A recent meta-analysis revealed over-
all environmental pollution to have large effects
on abnormality frequencies but only medium
effects on survival and no effects on time of de-
velopment (29)." [@koehler_wildlife_2013]


"Generally, single-
chemical risk assessment will probably under-
estimate the actual risks of pesticide mixtures to
fish, as combinations of organophosphates and
carbamates were shown to exert synergistic neu-
rotoxicity and unpredicted mortality in Pacific
salmon (35)." [@koehler_wildlife_2013]

" So, despite all efforts to increase the
specificity of insecticides, there is as yet no com-
pound that both targets insect pests and leaves
nontarget insects unaffected" [@koehler_wildlife_2013]



köhler and triebskorn pesticide classification: where do they have it from?

what is really new and an improvement of the ECOTOX data base is the querying of regional and habitat data and automated checking!!


The EPA ECOTOX data base !citation! is a valuable resource for ecotoxicological test data. When it was last updated (June 7, 2018) it contained 910,465 test results of 11,583 different chemicals that were tested on 12,599 organisms.

there ain't no habitat data base on the web
except gbif fuzzy coded data$habitat column


# Methods

For all concentration columns patterns like + and * are deleted



### EPA ECOTOX data
In a first step the latest version of the EPA ECOTOX data base was downloaded (version: June 7, 2018) and built into a local PostgreSQL data base [@szocs_build_2016]. The data base was subsequently queried for __endpoints__ such as _half maximal effective concentrations - LC50, EC50, LD50, LT50, IC50, ED50 and ET50 (further denoted as EC50)_, _No-observed-adverse-effect level - NOEC, NOEL_ and _lowest observed concentrations - LOEC, LOEL_ [@elonen_ecotoxicology_2018]. Data on other enpoints such as EC25 are ignored. Reported _compound concentrations_ are converted to µg/L and µg/kg respecitvely whenever possible.

### Other data sources
In order to retrieve additional __chemical parameters__, CAS numbers (e.g. 210880-92-5) that are retrieved from the EPA ECOTOX data base are then used to query other publically available data bases with the help of the webchme R-package [@szocs_webchem_2015] or directly through respective APIs. Likewise __habitat parameters__ are retrieved from online database such as the World Register of Marine Species (WoRMS) [@worms_editorial_board_world_2018] and the Global Biodiversity Information Facility (GBIF) [@gbif.org_gbif_2018]. To some extent the EPA ECOTOX data base itself also contains information on organism hatbitats [@elonen_ecotoxicology_2018]. __Regional parameters__, that consitute natural occurrences of tested organisms are retrieved from GBIF. Original names and newly assigned names of the parameters are listed in \@ref(meta-refs).

```{r meta-stats, echo=FALSE}
meta = fread(file.path(cachedir, 'meta.csv'))
knitr::kable(meta)
```



### Regional data

Taxonomic data retrieved from the EPA ECOTOX data base is cleaned and only taxa that are determined until Genus level are kept. Subsequently taxa are queried using the rgbif-package [@chamberlain_rgbif_2018].

__what about different chemical class columns?__

__show overview plots or in suplimentary materials__

The whole process is automated and scheduled to be re-run four times a year.

Building the the data base is updated quaterly whenever a new version from the EPA can be downloaded. Based on the EPA ECOTOX data base CAS and taxa information are extracted and queried against other online available data bases to retrieve information which is lackign in the ECOTOX data base. 




water solubility

maybe also include degredation (water and soil) ?
information for the classification of chemicals






```{r organigram-conversion, echo=FALSE, include=TRUE, eval=FALSE}
# TODO can this be done at the end of the TiX file?
pdf_file = '/home/andreas/Documents/Projects/etox-base/TeX/organigram1.pdf'
png_file = '/home/andreas/Documents/Projects/etox-base/TeX/organigram1.png'

system(sprintf('convert -density 300 %s %s', pdf_file, png_file))
```

![Figure](/home/andreas/Documents/Projects/etox-base/TeX/organigram1.png)


# Discussion

discuss problem of lacking data in GBIF on Africa. And Asia is way to big.

## Classification of chemicals
classification of chemical substances or compounds is not trivial.
* Approaches
  * Use-oriented:
    * Pesticide classification according to degree of harzard based on the acute oral and dermal toxicity to rats [@international_program_on_chemical_safety_who_2010]
  * Environment
    * MOA
  * Chemical classes
    * ohp document - private company for selling pesticides

quality of data in GBIF for instance in Africa is low. Continental refinement should be used with caution.

some ecotox test results might be flawed

Generally information on habitats is not easy to find. Only worms, algaebase and some others provide it, therefore own list.

it would be valuable to include other resources such as PPDB and algaebase. however they are proprietary.

There is a need for a __habitat__ and __chemical classification__ data base!

## Taxonomy:

Dinoflagelates are considered autotroph, although mixotrophy in this taxon has been proven [@]stoecker_mixotrophy_1999



# References











