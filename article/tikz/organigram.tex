\documentclass[border = 1.5cm]{standalone}

%%%% packages
\usepackage{tikz}
\usetikzlibrary{trees,
                arrows,
                shapes.geometric,
                positioning,
                calc,
                backgrounds,
                fit}

%%%% document
\begin{document}

%%%% layers
\pgfdeclarelayer{bg1}    % declare background layer
\pgfdeclarelayer{bg2}
\pgfdeclarelayer{bg3}
\pgfsetlayers{bg3,bg2,bg1,main}  % set the order of the layers (main is the standard layer)

%%%% styles
\tikzset{
	font = {\fontsize{13pt}{12}\sffamily},
	children/.style = {anchor = west},
	box/.style = {rectangle, text centered, draw = black, anchor = north west},
	iomain/.style = {rectangle, minimum width = 4cm, minimum height = 3cm, text centered, draw = black, fill = blue!10},
	main/.style = {rectangle, draw = black, rounded corners, minimum width = 3cm, minimum height = 1.25cm, text centered, anchor = west},
	etox-base/.style = {rectangle, rounded corners},
	etox-base-shiny/.style = {circle},
	ids/.style = {diamond, minimum width = 3cm, minimum height = 2cm, text centered, draw = black, fill = green!30},
	res/.style = {rectangle, rounded corners, minimum width = 2cm, minimum height = 1cm, text centered, draw = black, fill = blue!30},
	resvariables/.style = {rectangle, minimum width = 2cm, minimum height = 1cm, text centered, anchor = west},
	arrow/.style = {->, > = stealth, draw = black, color = gray!80, line width = 2.5pt},
	background/.style = {rectangle, rounded corners, minimum width=23cm, fill=gray!10},
	arrow2/.style = {->, > = latex, gray!10, line width=10pt}
}

    %%%% picture
    \begin{tikzpicture}[
	grow via three points={one child at (0.5,-1) and
		two children at (0.5,-1) and (0.5,-1.7)},
	edge from parent path={(\tikzparentnode.south) |- (\tikzchildnode.west)},
	inner sep = 0pt, outer sep = 0pt
	]
	
	%% EPA ECOTOX node
	\node (io) [iomain, align = center] at (0cm,0cm) {EPA ECOTOX\\data base\\(cleaned)};
	%\node (chemprop) [io, dashed, right of=io, xshift=2cm] {CHEMPROP};
	%\node (etox) [io, dashed, right of=chemprop, xshift=2cm] {UBA etox};
	
	%% run + setup scripts
	\begin{scope}[local bounding box = run]
	\node (run) [main, above of = io, yshift=9cm, xshift=3cm, align=center] {Run Algorithm}
	    child{ node [children] { \textbf{run\_build.R} }};
	\node (setup) [main, right of = run, xshift = 5cm, align = center] {Setup\\Environment}
	    child{ node [children] { \textbf{setup.R} }};
	\end{scope}
	
	
	%% build & data scripts
	\begin{scope}[local bounding box = build]
    % main nodes
	\node (download) [main, above of=io, yshift=4.5cm, xshift=16cm, align=center,
	                  minimum width=4cm, minimum height=2cm] {Download\\EPA ECOTOX\\data base}
	    child { node [children, yshift = -0.5cm] { \textbf{bd\_epa\_download.R} }};
    \node (build) [main, left of=download, xshift=-5cm, align=center,
                   minimum width=4cm, minimum height=2cm] {Build\\EPA ECOTOX\\data base}
	    child { node [children, yshift = -0.5cm] { \textbf{bd\_epa\_postgres.R} }};
	\node (data) [main, left of=build, xshift=-5cm, align = center,
	              minimum width=4cm, minimum height = 2cm] {Prepare\\EPA ECOTOX\\data base}
	    child { node [children, yshift = -0.5cm] { \textbf{da\_epa1.R} }} 
	    child { node [children, yshift = -0.5cm] { \textbf{da\_epa2.R} }}
	    child { node [children, yshift = -0.5cm] { \textbf{da\_epa3.R} }};
	\end{scope}
	% bbox
	\begin{pgfonlayer}{bg3}
	\node (back_data) [background, minimum height=5cm, above of=download, xshift=-6cm, yshift=-2cm];
	\node (back_data_label) [right of = back_data, xshift = 11.5cm, rotate = 90, align=center]
	    {\huge{Data \& Build}\\\huge{scripts}};
	\end{pgfonlayer}
	
	%% chemicals and organisms
	\begin{scope}[local bounding box = query]
	\node (cas) [ids, below of=io, yshift = -2.5cm, xshift = 3cm] {CAS};
	% main nodes
	\node (chemscr) [main, right of=cas, xshift=4.5cm] {PHYS-CHEM}
    	child { node [children] { Alan Wood Pesticide Compendium - \textbf{qu\_aw.R } }}
    	child { node [children] { Pesticide Action Network - \textbf{qu\_pan.R} }}
    	child { node [children] { PhysProp - \textbf{qu\_pp.R} }}
    	child { node [children] { PubChem - \textbf{qu\_pubchem.R} }};
	\node (taxon) [ids, below of=cas, yshift=-6cm, align = center] {Taxon};
	% main nodes
	\node (habitat) [main, right of = taxon, xshift = 4.5cm, yshift = 1.5cm] {Habitats}
    	child { node [children] { WORMS data base - \textbf{qu\_worms.R} }}
    	child { node [children] { Manual Search - \textbf{qu\_manual.R} }};
	\node (region) [main, right of = taxon, xshift = 4.5cm, yshift = -1.5cm] {Regions}
	    child { node [children] { GBIF - \textbf{qu\_gbif.R} }};
	\end{scope}
	% bbox
	\begin{pgfonlayer}{bg3}
	\node (back_query) [background, minimum height=12cm, above of=cas, xshift=7cm, yshift=-5.5cm];
	\node (back_query_label) [right of = back_query, xshift = 11.5cm, rotate = 90]
	    {\huge{Query scripts}};
	\end{pgfonlayer}
	
	%% result
	\node (testres) [main, right of = cas, xshift = 14cm, yshift = -13cm] {Merge}
	    child { node [children]  { \textbf{re\_merge.R} }}
	    child { node [children]  { \textbf{re\_combine.R} }};
	\node (analysesres) [main, left of = testres, xshift = -4.5cm] {Analyses}
	    child { node [children]  { \textbf{re\_analyses.R} }};
	\node (checksres) [main, left of = analysesres, xshift = -4.5cm] {checks}
	    child { node [children]  { \textbf{re\_checks.R} }};
	\node (finalres) [main, left of = checksres, xshift = -4.5cm] {Final Table}
	    child { node [children]  { \textbf{re\_final.R} }};
	% bbox
	\begin{pgfonlayer}{bg3}
	\node (back_result) [background, minimum height=4cm, above of=finalres, xshift=8.5cm, yshift=-1cm];
	\node (back_result_label) [right of = back_result, xshift = 11.5cm, rotate = 90, align = center]
	    {\huge{Result}\\\huge{scripts}};
	\end{pgfonlayer}
	
	%% writing
	\node (writedb) [main, below of = finalres, yshift=-3cm, align = center] {Write to\\Data Base}
	    child { node [children] { \textbf{wr\_dbase.R} }};
	\node (writeapp) [main, right of = writedb, xshift=3cm] {Write to app}
	    child { node [children] { \textbf{wr\_app.R}  }};
	\node (writemeta) [main, right of = writeapp, xshift=3cm] {Write Meta data}
	    child { node [children] { \textbf{wr\_meta.R} }};
	\node (writestats) [main, right of = writemeta, xshift=3cm] {Write statistics}
	    child { node [children] { \textbf{wr\_stats.R} }};
	
	\begin{pgfonlayer}{bg3}
	\node (back_writing) [background, minimum height=3cm, above of = writedb, xshift=8.5cm, yshift=-1cm];
	\node (back_writing_label) [right of = back_writing, xshift = 11.5cm, rotate = 90, align = center]
	    {\huge{Writing}\\\huge{scripts}};
	\end{pgfonlayer}

    %%% arrows %%%
	\begin{pgfonlayer}{bg1}
	% io
	\draw [arrow] (io.east) -| (testres);
	% build & data
	\draw [arrow] (download.west) -- (build.east);
	\draw [arrow] (build.west) -- (data.east);
	\draw [arrow] (data.west) -| (io.north);
	% query
	\draw [arrow] (io) |- (cas.west);
	\draw [arrow] (cas.east) -- (chemscr.west);
	\draw [arrow] (chemscr.east) -| (testres.north);
	\draw [arrow] (io) |- (taxon.west);
	\draw [arrow] (taxon.east) -- (habitat.west);
	\draw [arrow] (taxon.east) -- (region.west);
	\draw [arrow] (habitat.east) -| (testres.north);
	\draw [arrow] (region.east) -| (testres.north);
	% result
	\draw [arrow] (testres) -- (analysesres);
	\draw [arrow] (analysesres) -- (checksres);
	\draw [arrow] (checksres) -- (finalres);
    % writing
    \foreach \x in {writedb, writeapp, writemeta, writestats}
	    { \draw [arrow] (finalres) -- +(0,-2.75) -| (\x.north); }
	% run + setup
	\draw [arrow2] (run.east) -- (setup.west);
	\foreach \x in {back_data, back_query, back_result, back_writing}
	    { \draw [arrow2] (run.west) -- +(-4,0) |- (\x.west); }
	
	%% picture
	% \node (epalogo) [] { \includegraphics[]{https://worldvectorlogo.com/fr/logo/epa-1}};
	
	\end{pgfonlayer}
	\end{tikzpicture}
\end{document}

