---
title: "Source PPDB data"
author: "Andreas ScharmÃ¼ller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
editor_options:
  chunk_output_type: console
---

# Setup
```{r setup}
# packages
require(data.table)
require(webchem)

# switches
online = FALSE

# variables
cachedir = '/home/andreas/Documents/Projects/species-sensitivity/cache'
fundir = '/home/andreas/Documents/Projects/species-sensitivity/functions'

# source
source('/home/andreas/Documents/UBA/Project/R/src/DB_access.R')
source(file.path(fundir, 'ppdb-0-0-5.R'))
source(file.path(fundir, 'ppdb_own_functions.R'))
```

# Load PSM data
```{r load-psm}
psm = readRDS(file.path(cachedir, 'psm2.rds'))
```

# Query PPDB data
```{r query, eval = TRUE}
# don't switch online on too often!
if (FALSE) {
  # create data.frame of indices before the loop - otherwise it's done every time!
  # ppdb_query() from version 0.05 only excepts cas (separated with hyphen)!
  idx = ppdb_buildidx()
  
  psm_fin = psm[ nchar(cas) > 0 ]
  # 21 entries which don't have a CAS: Mostly like: 'Azoxystrobin-CA'.  Azoxystronin itself has a CAS
  psm_fin = psm_fin[ !duplicated(cas) ]
  todo = psm_fin$cas
  
  # todo = todo[1:3] # debug me!
  
  ppdb_l = list()
  for (i in 1:length(todo)) {
    cas = todo[i]
    subst = psm_fin$subst_name[i]
    
    message(i, ') Querying: ', cas, ': ', subst)
    res = ppdb_query(cas, verbose = FALSE, index = idx)
    
    ppdb_l[[i]] = res
    names(ppdb_l)[i] = cas
  }
  
  saveRDS(ppdb_l, file.path(cachedir, 'ppdb_l.rds'))
  saveRDS(idx, file.path(cachedir, 'ppdb_idx.rds'))
  
} else {
  ppdb_l = readRDS(file.path(cachedir, 'ppdb_l.rds'))
  idx = readRDS(file.path(cachedir, 'ppdb_idx.rds'))
}

rm(idx)
```

### Extracting
```{r extracting}
## PPDB-scrap ----
# etox information
ppdb_dt = ppdb_etox(ppdb_l)
ppdb_dt[psm[, c('cas', 'subst_name')],
        subst_name := i.subst_name, on = 'cas' ]
# psm_type
ppdb_psm_dt = ppdb_psm_type(ppdb_l)
ppdb_dt = merge(ppdb_dt, ppdb_psm_dt, on = 'cas')
# PPDB name
ppdb_subst = ppdb_name(ppdb_l)
```


### Extra
For CAS that have more than one PPDB entry. In the case of Propiconazole there are __cis-propiconazole__, __propiconazole__, __trans-propiconazole__. The first one is taken by default, which lacks ecotoxicological data. However we want the second entry as this is the main compound with the most data. This should be included in ppdb_query() in the future. For now I substitute the values manualy.
```{r extra}
# looked up by hand
## Propiconazole
propiconazole = data.table(variable_id = NA,
                           subst_name = 'Propiconazole',
                           casnr = '60207901',
                           cas = '60207-90-1',
                           value = c(2.6, 0.068, 10.2, 0.31, 0.37, 8.0, 25.0, 4.9, 0.093),
                           unit = c('mg/L','mg/L','mg/L','mg/L','mg/L','mg/L','mg/kg','mg/L','mg/L'),
                           psm_type = 'fungicide',
                           source = 'ppdb',
                           duration = c(96,504,48,504,96,672,672,168,72),
                           duration_unit = 'h',
                           endpoint = c('lc50', 'noec', 'lc50', 'noec', 'lc50', 'noec', 'NOEC', 'EC50', 'EC50'),
                           latin_BIname = c('Leiostomus xanthurus', 'Oncorhynchus mykiss', 'Daphnia magna', 'Daphnia magna', 'Americamysis bahia', 'Chironomus riparius', 'Chironomus riparius', 'Lemna gibba', 'Navicula seminulum'),
                           ppdb_group = c('fish', 'fish', 'aquatic invertebrates', 'aquatic invertebrates', 'aquatic crustaceans', 'sediment dwelling organisms', 'sediment dwelling organisms', 'aquatic plants', 'algae'),
                           quality = c('A5', 'A5', 'A5', 'A5', 'F3', 'A5', 'A5', 'F3', 'A4'))

ppdb_dt_extr = rbindlist(list(propiconazole))

## PPDB-extra ----
ppdb_dt = rbindlist(list(ppdb_dt, ppdb_dt_extr), fill = TRUE)
```

### Cleaning
```{r cleaning}
# remove qualifier entiries > and <
ppdb_dt = ppdb_dt[ is.na(qualifier) | qualifier == '=' ]
ppdb_dt[ is.na(qualifier)]
# multiply value by 1000 to get Âµg/L
ppdb_dt[ unit == 'mg/L', `:=`
                         (value = value * 1000,
                          unit = 'ug/L')]
# only some Chiro NOEC values!
ppdb_dt[ unit == 'mg/kg', `:=`
                         (value = value * 1000,
                          unit = 'ug/kg')]
# change everything to hour (could already be done in the function - change this in the future!)
ppdb_dt[ , duration := ifelse(duration_unit == 'day', duration*24, duration) ]

ppdb_dt[ , duration_unit := 'hour' ]
ppdb_dt[ , casnr := gsub('-', '', cas) ]
ppdb_dt[ , variable_id := NA ]

# PPDB name
ppdb_dt[ppdb_subst, on = 'cas',
        subst_name := ifelse(is.na(subst_name), i.subst_name, subst_name)]
```

## Filter
```{r filter}
# EC50 tests
ppdb_dt = ppdb_dt[ tolower(endpoint) %in% c('lc50', 'ec50') ]
ppdb_dt = ppdb_dt[ substr(quality,2,2) %in% c('5', '4') ]
```

## Errata
```{r errata}
#### O. mykiss ----
ppdb_dt[ latin_BIname == 'Oncorhychus mykiss',
         latin_BIname := 'Oncorhynchus mykiss' ]
ppdb_dt[ latin_BIname %like% '(?i)Salmo gairdneri|Salmo gardneri|Salmo gairdneri|Salmo gardneri|Trout',
         latin_BIname := 'Oncorhynchus mykiss' ]
# from Salmonidae to O. mykiss
message('The taxon fot the following substances was set from Salmonidae to O. mykiss (like all other fish entries in PPDB - this seems to be a mistake)\n',
        paste0(ppdb_dt[ latin_BIname == 'Salmonidae' ,c('casnr', 'subst_name')],
               sep = '\n'))
ppdb_dt[ latin_BIname == 'Salmonidae',
         latin_BIname := 'Oncorhynchus mykiss' ]

#### P. promelas ----
ppdb_dt[ latin_BIname == 'Pimephalis promelas',
         latin_BIname := 'Pimephales promelas' ]
ppdb_dt[ latin_BIname == 'Pimehales',
         latin_BIname := 'Pimephales' ]

#### D. rerio ----
ppdb_dt[ latin_BIname == 'Brachydanio reri',
         latin_BIname := 'Danio rerio' ]

#### Lempomis ----
ppdb_dt[ latin_BIname == 'Lepomis machrochinus',
         latin_BIname := 'Lepomis macrochirus' ]
 
#### P. subcapitata ----
# a lot of spelling mistakes!
ppdb_dt[ latin_BIname %like% '(?i)Pseudokirchneriella subcaptata|Psuedokirchneriella subcapitata|Pseudokirchnella subcapitata|Pseudokirchneriella subcaptitata|Pseudokirch subcap|Pseudokircheriella subcapitata|Selenastrum capricornutum|Selenestrum capricornutum|Selenastrum|Rhapidocelis subcapitata|Raphidocelis subcapitata',
         latin_BIname := 'Pseudokirchneriella subcapitata' ]

#### Scenedesmus subspicatus ----
ppdb_dt[ latin_BIname %like% '(?i)Scenedesmus subspicutus|Scenedemus subspicatus|Scenedesmus subcapitata|Scenedesmus subspicutus',
         latin_BIname := 'Scenedesmus subspicatus' ]

#### Lemna ----
ppdb_dt[ latin_BIname == 'Lemna spp',
         latin_BIname := 'Lemna sp.']
```

## Grouping
```{r grouping }
ppdb_dt[ , .N, .(ppdb_group, duration) ]
```

## Cleaning2
```{r cleaning2}
# subset
ppdb_dt = ppdb_dt[ , c('variable_id', 'subst_name', 'casnr', 'cas', 'value', 'unit', 'psm_type', 'ppdb_group', 'source', 'duration', 'duration_unit', 'endpoint', 'latin_BIname') ]


# check
subst_check = 
  ppdb_dt[ is.na(casnr) | casnr == '' |
           is.na(cas) | cas == '' |
           is.na(subst_name) | subst_name == '' ]

if (nrow(subst_check) != 0) {
  warning(nrow(subst_check), ' missing CAS, CASNR or substance names.')
}
```

# Cleaning
```{r env-cleaning}
rm(ppdb_dt_extr, ppdb_psm_dt, propiconazole, subst_check, ppdb_subst, psm)
```
