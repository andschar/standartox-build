---
title: "Untitled"
author: "AS"
date: "March 26, 2018"
output: html_document
---

## Query bfg_monitoring data base [PUT AWAY COMPLETELY IN THE FUTURE!]
```{r DATA-daphnia-from-bfg-monitoring, eval = FALSE}
if (online) {
  #! FROM BFG MONITORING DATA BASE (not very elegant)!
  drv = dbDriver("PostgreSQL")
  con = dbConnect(drv, user = DBuser, dbname = DBname_1, host = DBhost, port = DBport, password = DBpassword)
  
  dm = dbGetQuery(con, "SELECT var.variable_id, var.name AS subst_name, var.casnr, prop.lc50_dm_fin AS value, prop.lc50_dm_fin_source AS source, var.psm_type
                        FROM phch.phch_variables var
                        JOIN phch.phch_variables_prop prop ON var.variable_id = prop.variable_id
                        WHERE var.psm_type IN ('fungicide', 'herbicide', 'insecticide', 'metabolite');")
  setDT(dm)
  
  dbDisconnect(con)
  dbUnloadDriver(drv)
  
  fwrite(dm, file.path(cachedir, 'bfg_dm_data.csv'))
  
} else {
  dm = fread(file.path(cachedir, 'bfg_dm_data.csv'))
}
  
# Biology
dm[ , `:=`
    (latin_BIname = 'Daphnia magna')]
     #genus = 'Daphnia',
     #family = 'Daphniidae') ]
# Other
dm[ , cas := casconv(casnr) ]
dm[ , unit := 'Âµg/L' ]
dm[ , source := paste0('bfg_', source) ]
dm[ , duration := NA ]
dm[ , endpoint := 'ec50' ]

dm = dm[ !is.na(value) ]

# Column order
setcolorder(dm, c('variable_id', 'subst_name', 'casnr', 'cas', 'value', 'unit', 'psm_type', 'source', 'duration', 'endpoint', 'latin_BIname'))
```
