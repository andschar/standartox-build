---
title: "Species sensitivity against pesticides"
author: "Andreas Scharmüller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  # pdf_document: default
  html_document:
    toc: true
    number_sections: yes
---

# Packages and functions

In a first step we define some variables and load required R-packages.
```{r setup, eval=TRUE, include=FALSE, echo=TRUE}
## switches
online = FALSE
plots = FALSE

## variables
cachedir = '/home/andreas/Documents/Projects/species-sensitivity/cache'
srcdir = '/home/andreas/Documents/Projects/species-sensitivity/src'
datadir = '/home/andreas/Documents/Projects/species-sensitivity'
fundir = '/home/andreas/Documents/Projects/species-sensitivity/functions'

## R-Packages
require(RPostgreSQL)
require(plyr)
require(webchem)
require(ggplot2)
require(scales)
require(gridExtra)
require(zoo)
require(cowplot)
require(RCurl)
require(readxl)
require(data.table)
require(stringr)
require(knitr)
require(xtable)
require(DT)

## Source scripts
source('/home/andreas/Documents/UBA/Project/R/src/DB_access.R')
source('/home/andreas/Documents/UBA/Project/R/src/gg_theme_AS.R')
source(file.path(fundir, 'ppdb-0-0-5.R')) # sourcing deprecated ppdb-query (was still active in V 0.0.5)
source(file.path(fundir, 'functions.R')) # functions
source(file.path(fundir, 'casconv.R'))
```

# Load pesticide data

The data for our analyses is stored in the bfg_monitoring data base. We query information on the 484 substances that were found between 2005 and 2015 in sites in small streams by the governmental monitoring. Additionally data from a sampling campaign in Romania is loaded.

## PSM bfg_monitoring
```{r DATA-bfg, eval=TRUE, include=TRUE, echo=TRUE}
if (online) {
  drv <- dbDriver("PostgreSQL")
  con <- dbConnect(drv, user = DBuser, dbname = DBname_1, host = DBhost, port = DBport, password = DBpassword)
  
  
  psm_db = dbGetQuery(con, "SELECT DISTINCT ON (name) variable_id, name AS subst_name, cas, casnr, psm_type, pan_class
                             FROM phch.phch_variables;")
  setDT(psm_db)
  
  sam_ezg = dbGetQuery(con, "SELECT var.variable_id, var.cas, var.casnr, var.name AS subst_name, var.psm_type, var.rak_uba0317,
                             var.ger_auth_2015, 
                             prop.lc50_dm_fin,
                             samp.date, samp.value_fin, samp.site_id,
                             rain.rain_md, rain_db,
                             site.area_sqkm, site.atkis_perc
                            FROM views.psm_samples_2005 samp
                            JOIN phch.phch_variables var ON var.variable_id = samp.variable_id
                            JOIN phch.phch_variables_prop prop ON var.variable_id = prop.variable_id
                            JOIN phch.phch_ec50 ec50 ON var.variable_id = ec50.variable_id
                            JOIN spatial_derived.land_use_ezg5000 site ON samp.site_id = site.site_id
                            JOIN spatial_derived.psm_samples_2005_rain rain ON samp.sample_id = rain.sample_id
                            WHERE var.psm_type IN ('insecticide', 'herbicide', 'fungicide', 'metabolite')")
  setDT(sam_ezg)
  
  dbDisconnect(con)
  dbUnloadDriver(drv)
  
  saveRDS(psm_db, file.path(cachedir, 'psm_db.rds'))
  saveRDS(sam_ezg, file.path(cachedir, 'sam_ezg.rds'))
  
} else {
  psm_db = readRDS(file.path(cachedir, 'psm_db.rds'))
  sam_ezg = readRDS(file.path(cachedir, 'sam_ezg.rds'))
}

psm_db = psm_db[ psm_type %in% c('fungicide', 'herbicide', 'insecticide', 'metabolite')]
psm_db[ casnr == '', casnr := NA ]
psm_db[ , cas := ifelse(!is.na(casnr), casconv(casnr), NA) ]

## checks
if (any(duplicated(psm_db$casnr))) {
  warning('Duplicated CASNR')
  psm_db[ !is.na(casnr) & duplicated(casnr) ]
  message('Checked on 2018-03-15.\nDuplicate is Desehtylsimazin & Desethylatrazin.')
}
if (anyNA(psm_db$casnr)) {
  warning('CASNR with NA.')
  message('Checked on 2018-03-15.\nNAs are mostly metabolites and sumed pesticides.')
}
if(any(!is.na(psm_db$casnr) & psm_db$casnr == ''))
  warning('CASNR with \'\'.')
```

## PSM Romania
```{r DATA-romania, eval=TRUE, include=TRUE, echo=TRUE}
# files from Verena
# 0) new file:
psm_rom0 = fread('/home/andreas/Documents/data/romania/det_compounds_with_CAS.csv')
psm_rom0[ , casnr := casconv(cas) ]
names(psm_rom0)[1] = 'subst_name'
any(duplicated(psm_rom0$casnr))

#### old ----
# 1) first file:
psm_rom1 = fread('/home/andreas/Documents/UBA/data/PPP_without_EC_50_Verena_Romania.csv')
names(psm_rom1)[3] = 'subst_name'; names(psm_rom1)[6] = 'active_comp'
psm_rom1 = psm_rom1[ ,c('subst_name', 'active_comp', 'casnr')]
psm_rom1[ , casnr := as.character(casnr) ]
psm_rom1[ , cas := casconv(casnr) ]
psm_rom1 = psm_rom1[ !psm_rom1$casnr %in% psm_rom0$casnr ]

# 2) second file:
psm_rom2 = fread('/home/andreas/Documents/UBA/data/Missing_compounds.csv')
psm_rom2 = psm_rom2[ ,-c(1,3)]
psm_rom2[ , casnr := as.character(casnr) ]
psm_rom2[ , cas := casconv(casnr) ]
psm_rom2 = psm_rom2[ !psm_rom2$casnr %in% c(psm_rom0$casnr, psm_rom1$casnr)]
names(psm_rom2)[1] = 'active_comp'

# bind dts
psm_rom = rbindlist(list(psm_rom0, psm_rom1, psm_rom2), fill = TRUE)

# # Check whether PSM Romania are on bfg_monitoring
# drv = dbDriver("PostgreSQL")
# con = dbConnect(drv, user = DBuser, dbname = DBname_1, host = DBhost, port = DBport, password = DBpassword)
# 
# phch_var = dbGetQuery(con, "SELECT * FROM phch.phch_variables")
# setDT(phch_var)
# 
# dbDisconnect(con)
# dbUnloadDriver(drv)
# 
# psm_rom[ casnr %in% phch_var$casnr ]
# psm_rom

## check
if (any(duplicated(psm_rom$casnr)))
  warning('Duplicated CASNR')
if (anyNA(psm_rom$casnr))
  warning('CASN with NA')
```

As we don't know what types of compounds we have in Romania we query the PPDB.
```{r DATA-romania-query, eval=TRUE}
online2 = FALSE
if (online2) {
  todo = psm_rom$cas
  # todo = todo[1:3] # debug me!
  
  ppdb_l = list()
  for (i in 1:length(todo)) {
    subst = todo[i]
    res = ppdb_query(subst, verbose = FALSE)
    message(i, ') Result of ', subst, ': ', res)
    
    ppdb_l[[i]] = res
    names(ppdb_l)[i] = subst
  }
  saveRDS(ppdb_l, file.path(cachedir, 'ppdb_l_rom.rds'))
  
} else {
  ppdb_l = readRDS(file.path(cachedir, 'ppdb_l_rom.rds'))
}

# function to extract psm type form PPDB output
extr_psm_type = function(ppdb_list) {
  # extract the general list within the PPDB list for each cas
  general_list = lapply(ppdb_list, function(x) lapply(x, '[')$general)
  # extract the value for each cas
  pest_list = lapply(general_list, '[', 1, 2)
  # convert NULL to NA
  psm_raw = unlist(lapply(pest_list, function(x) if (is.null(x)) NA else x))
  psm_type = ifelse(grepl('inse', psm_raw, ignore.case = TRUE), 'insecticide',
             ifelse(grepl('herb', psm_raw, ignore.case = TRUE), 'herbicide',
             ifelse(grepl('fung', psm_raw, ignore.case = TRUE), 'fungicide', NA)))
  dt = data.table(cas = names(ppdb_list),
                  psm_type = psm_type)
  return(dt)
}

ppdb_dt = extr_psm_type(ppdb_l)

## update psm_type column on PPDB query
psm_rom[ppdb_dt, psm_type := psm_type, on = 'cas']
rm(ppdb_dt, ppdb_l)
```

```{r PSM-combine, eval=TRUE}
## combine pesticide data sets:
psm_rom = psm_rom[ !casnr %in% psm_db$casnr ]
psm = merge(psm_db, psm_rom, on = 'casnr', all.x = TRUE, all.y = TRUE)

## checks
if (any(duplicated(psm$casnr))) {
  warning('Duplicated CASNR')
  warning('Checked on 2018-03-15.\nDuplicate is Desehtylsimazin & Desethylatrazin.')
  duplcas = psm[ !is.na(casnr) & duplicated(casnr) ]
  fwrite(duplcas, file.path(tempdir(), 'duplcas.csv'))
  duplcas
}
if (anyNA(psm$casnr)) {
  warning('CASNR with NA.')
  warning('Checked on 2018-03-15.\nNAs are only metabolites and sumed pesticides.')
  nocas = psm[ is.na(casnr), c('subst_name', 'cas', 'casnr', 'psm_type') ]
  fwrite(nocas, file.path(tempdir(), 'nocas.csv'))
  nocas
}
if(any(!is.na(psm$casnr) & psm$casnr == '')) {
  warning('CASNR with \'\'.')
}

psm = psm[ !is.na(casnr) ]
psm[ , cas := ifelse(!is.na(casnr), casconv(casnr), NA) ]

saveRDS(psm, file.path(cachedir, 'psm1.rds'))
rm(psm_db, psm_rom0, psm_rom1, psm_rom2)
```


## Query for additional chemical properties

### Retrieve chemical group data from the Alan Wood pesticide compendium [NOT YET FINISHED!]
```{r QUERY-aw, eval=FALSE}
# todo = psm$cas
# # todo = todo[1:2] debug!
# aw_list = list()
# for (i in 1:length(todo)) {
#   cas = psm$cas[i]
#   aw_list[[i]] = aw_query(cas, type = 'cas') # Aland wood's compendium
#   result_list = aw_list[[i]][[cas]]
#   if (!is.null(result_list[[1]]) && !is.na(result_list[[1]])) {
#       psm$aw_activity[i] = result_list$activity
#       psm$aw_subactivity[i] = result_list$subactivity
#     } else {
#       psm$aw_activity[i] = NA
#       psm$aw_subactivity[i] = NA
#     }
# }
```


# Load organism data

Invertebrate Taxa found in Germany and Taxa listed in monitoring guidlines and data bases. In order to limit toxicity test reults to only European taxa a vector of Taxa names is created building upon different Taxa lists incorporating data from the [__freshwaterecology.info database__](http://freshwaterecology.info/), taxa included in the [__Fliessgewässerbewertung database__](http://www.fliessgewaesserbewertung.de/) and taxa that are listed in a databse on invertebrates in Germany: __bfg_monitoring__.

## MZB 
data from data base bfg_monitoring, website freshwaterecolog.info and fliessgewaesserbewertung
```{r DATA-MZB, eval=TRUE, echo=TRUE, include=FALSE, message=FALSE}
if (online) {
  message('online = TRUE')
  source(file.path(srcdir, 'mzb_data.R')) # bfg_monitoring
  mzb_sp
  mzb_gn
  source(file.path(srcdir, 'freshwaterecology_data.R')) # freshwaterecology.info
  fwecol_sp
  fwecol_gn
  source(file.path(srcdir, 'fliessgewaesserbewertung.R')) # Fliessgewässerbewertung
  fl_bew_sp
  fl_bew_gn
  
  ## combine all MZB Tax
  mzb_sp_fin = sort(unique(c(mzb_sp, fwecol_sp, fl_bew_sp)))
  mzb_gn_fin = sort(unique(c(mzb_gn, fwecol_gn, fl_bew_gn)))
  
  # remove not needed
  rm(mzb_sp, fwecol_sp, fl_bew_sp)
  
  fwrite(list(mzb_sp_fin), file.path(cachedir, 'mzb_sp_fin.csv'))
  fwrite(list(mzb_gn_fin), file.path(cachedir, 'mzb_gn_fin.csv'))

} else {
  message('online = FALSE')
  mzb_sp_fin = unlist(fread(file.path(cachedir, 'mzb_sp_fin.csv'), sep = ','))
  mzb_gn_fin = unlist(fread(file.path(cachedir, 'mzb_gn_fin.csv'), sep = ','))
}
```

```{r DT-MZB-taxa, eval=FALSE, echo=TRUE}
mzb_sp_finNA = c(mzb_sp_fin, rep(NA, 4)) # length(mzb_fin) / 5 # real number, no recycling when creating a matrix
tbl = matrix(mzb_sp_finNA, ncol = 5, byrow = TRUE)
DT::datatable(
  tbl, colnames = 'Species',
  width = 300, 
  class = 'cell-border',
  caption = 'Benthic organisms that are listed in the bfg_monitoring data base, in the freshwatercology.info data base')
rm(mzb_sp_finNA, tbl)
```

## Diatoms
```{r DATA-Diatoms, eval=TRUE, echo=TRUE}
if (online) {
  drv = dbDriver("PostgreSQL")
  con = dbConnect(drv, user = DBuser, dbname = DBname_1, host = DBhost, port = DBport, password = DBpassword)
  
  dia = dbGetQuery(con, "SELECT *
                         FROM dia.dia_samples")
  
  dbDisconnect(con)
  dbUnloadDriver(drv)
  
  dia_sp_fin = unique(dia$taxon)
  dia_gn_fin = unique(sapply(strsplit(dia_sp_fin, ' '), '[', 1))
  
  fwrite(list(dia_sp_fin), file.path(cachedir, 'dia_sp_fin.csv'))
  fwrite(list(dia_gn_fin), file.path(cachedir, 'dia_gn_fin.csv'))
          
} else {
  dia_sp_fin = unlist(fread(file.path(cachedir, 'dia_sp_fin.csv'), sep = ','))
  dia_gn_fin = unlist(fread(file.path(cachedir, 'dia_gn_fin.csv'), sep = ','))
}
```




# Ecotoxicological test data

In this section we query different data bases on ecotoxicological tests. The [ETOX data base](https://webetox.uba.de/webETOX/index.do?language=en) from the German Environmental Agency (UBA - Umweltbundesamt), the [US EPA ECOTOX data base](https://cfpub.epa.gov/ecotox/)

## UBA ETOX data database [NOT YET FINISHED]
```{r DATA-ETOX, eval=FALSE, include=FALSE}

# require(httr)
# require(xml2)
# query = '210880-92-5'
# source('src/etox_function_test.R')
# etox_id = get_etoxid2(query = query, match = 'all', type = 'cas')
# 
# webchem::etox_basic(etox_id[[1]][1])
# webchem::etox_tafrgets(etox_id[[1]][1])
# webchem::etox_tests(etox_id[[1]][1])

```

## EPA ECOTOX database

The data is queried/loaded in _EC50aggregation.Rmd_ mainly into the object epa1

```{r SOURCE-EC50-aggregation}
# also loads familylookup.Rmd
ksource(file.path(datadir, 'src', 'EC50aggregation.Rmd'))
```

### Number of organism groups in the whole EPA ECOTOX database  
```{r DATA-EPA-organism-overview, eval=TRUE, echo=TRUE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, user = DBuserL, dbname = DBnameL, host = DBhostL, port = DBportL, password = DBpasswordL)

total_tests = dbGetQuery(con, '
SELECT DISTINCT ON (c.ecotox_group_convert) c.ecotox_group_convert AS organism_group, COUNT(c.ecotox_group_convert)
FROM ecotox.tests t
RIGHT JOIN ecotox.species s ON t.species_number = s.species_number
LEFT JOIN lookup.ecotox_group_convert c ON s.ecotox_group = c.ecotox_group
GROUP BY c.ecotox_group_convert')

total_tests = setorder(as.data.table(total_tests), -count)
names(total_tests) = c('Organism group', 'N')

invisible(dbDisconnect(con))
invisible(dbUnloadDriver(drv))

# kable(na.omit(total_tests)) %>%
#   kable_styling(full_width = FALSE) # doesn't work
```

```{r KABLE-EPA-orgnism-overview, eval=TRUE, echo=TRUE}
kable(na.omit(total_tests), format = 'html', table.attr = "style='width:30%;'",
      caption = 'Number of ecotoxicological tests in the EPA ECOTOX data base per organism group (classification by EPA)')

# DT::datatable(total_tests, 
#               rownames = FALSE, 
#               width = 300, 
#               class = 'cell-border',
#               caption = 'Test results on ecotoxicological tests ordered by number of tests')
rm(total_tests)
```
Fish are the most tested organism group, followed by plants and insects.

### Query for aquatic organism ecotoxicological tests {#QUERY-organisms}
In a next step we queried the EPA ECOTOX database for ecotoxicological test results limiting the query to tests with EC/LC50 results only and a test duration range from 23 to 120 hours. Furthermore we reduced the result to the following organism groups: Algae, plants, invertebrates, crustaceans, insects, molluscs and fish. Although most of the tested insects are living in a terrestrial habitat, some quatic inseccts are within this EPA group. We also excluded tests which were assigned to a soil habitat. Although there are column organism_habitat comprises _water_, _soil_ and _non-sloil_ categories we couldn't rely just on the category _water_ as most of the column had no entries. Likewise in the subhabitat column we were only able to exclude _D - _, _F - Forest_, _G - _ and _M - Marine_ and not rely only on the categories _P - Palustrine_, _R - Riverine_, _L - Lacustrine_ and _E - Estuarian_  due to the same reason. We downloaded the [US EPA ECOTOX database version (03_14_2017)](https://cfpub.epa.gov/ecotox/) and built a local version of it following [this guide](http://edild.github.io/localecotox/).

TUs are also calculated in TU_calculation.Rmd

### Categorize EPA taxa groups


#### EC50 values and test organisms
```{r DT-EPA-tests, eval=TRUE}
DT::datatable(epa1[ ,c('cas', 'subst_name', 'value', 'psm_type', 'pan_class', 'chemical_group',
                       'family', 'genus', 'latin_BIname', 'ecotox_group')],
              colnames = c('conc' = 3, 'species' = 9, 'organism_group' = 10),
              rownames = FALSE,
              class = 'cell-border')
```

#### Most tested substances:
The most tested substances accoring to the EPA ECOTOX data base are Atrazin, Methoxyfenozid, Tebufenozid, Chlorpyrifos and p,p-DDT.
```{r DT-EPA-tests-per-substance, eval=TRUE}
DT::datatable(
  epa1[ , .N, by = .(casnr, subst_name)][order(-N)],
  rownames = FALSE,
  class = 'cell-border'
  )
```

#### Most tested organisms
```{r DT-EPA-tests-per-organism, eval=TRUE}
DT::datatable(
  epa1[ , .N, by = .(latin_BIname, family, ecotox_group)][order(-N)],
  rownames = FALSE,
  class = 'cell-border'
  )
```

#### EPA ECOTOX results checks

In order to check whether categorical varaibles in the data bases help the analysis we analyse how well they are filled in.

```{r CHECK-epa-result, eval=TRUE}
## checks and balances
table(epa1$organism_habitat, exclude = NULL) # habitat categories

table(epa1$subhabitat, exclude = NULL) # subhabitat categories (E-Estuarian, L-Lacustrine, P -, R-Riverine)
table(epa1$ecotox_group, exclude = NULL) # EPA organism group classification
summary(epa1$obs_duration_conv, na.rm = TRUE) # ecotox test duration range (hrs)
```

## Match ecotox tests with freshwater species | genera

using Taxize amongst other stuff

### Filter genera and species level

The following code excludes tests for which only the family level of the tested taxa was reported. From 2896 test results 2877 remain after this step. In a second step test entries like _Apis sp._ are marked in the column spec_lvl (0).

```{r FILTER-genus-species, eval=TRUE, echo=TRUE, include=TRUE}
# exclude taxa which aren't determined until Genus level
epa1 = epa1[ genus == gsub('(\\w+).+', '\\1', latin_name) ]
# taxa identified 'till species level
epa1[ , spec_lvl := ifelse(grepl('\\.', epa1$latin_BIname), '0', '1') ]
# Count word in Species coĺumn (expected to be two - allows for hyphen)
# all(sapply(gregexpr("\\W[-]+", epa1sp$latin_BIname), length) + 1 == 2)
## count entries with hyphens
# epa1sp[sapply(gregexpr("\\W+", epa1sp$latin_BIname), length) + 1 != 2, ]
```


```{r DEPRECATED-SAVE-image, eval=TRUE, echo=FALSE}
# source('/home/andreas/Documents/UBA/Project/R/src/functions.R')
# paste0('Saving: ', workspace.size(object = ls())$total)
# save.image(file.path(cachedir, 'EC50-sensitivity.RData'))
```

