\documentclass{article}
%\usepackage{graphicx} % includegraphics
%% packages
\usepackage{tikz}
\usetikzlibrary{trees, arrows, shapes.geometric} % TikZ libraries
%\usetikzlibrary{backgrounds}
\usepackage{lscape}

%% layers
\pgfdeclarelayer{bg1}    % declare background layer
\pgfdeclarelayer{bg2}
\pgfsetlayers{bg2,bg1,main}  % set the order of the layers (main is the standard layer)

\begin{document}
	
\thispagestyle{empty} % removes the 1

% tree styles (defined by template)
\tikzstyle{every node}=[draw=black,thick,anchor=west]
%\tikzstyle{selected}=[draw=red,fill=red!30]
%\tikzstyle{optional}=[dashed,fill=gray!50]
% self defined
\tikzstyle{io}=[rectangle, minimum width = 4cm, minimum height = 1cm, text centered, draw = black, fill = blue!10]
\tikzstyle{main}=[rectangle, rounded corners, minimum width = 3cm, minimum height = 1cm, text centered, draw = black, fill = purple!30]
\tikzstyle{ids}=[diamond, minimum width = 3cm, minimum height = 1cm, text centered, draw = black, fill = green!30]
\tikzstyle{res}=[rectangle, rounded corners, minimum width = 2cm, minimum height = 1cm, text centered, draw = black, fill = blue!30]
\tikzstyle{resvariables}=[rectangle, minimum width = 2cm, minimum height = 1cm, text centered, draw = black]
\tikzstyle{steps} = [rectangle, minimum width = 1cm, text centered, fill = yellow]

%arrows
\tikzstyle{arrow} = [->, > = stealth, draw = black, color = yellow!80, line width = 6pt]
% TODO double colored arrows - don't know how it works
\iffalse
\tikzset{
	darrow/.style args={#1 colored by #2 and #3}{
		-stealth,line width=#1,#2, % first arrow
		postaction={draw,-stealth,#3,line width=(#1)/3,
			shorten <=(#1)/3,shorten >=2*(#1)/3}, % second arrow
	}
}
\fi


\begin{landscape}
%\parindent=0pt % extra spaces towards the edges
%\eject\null
%\vfill
%\hspace*{-4cm}

\begin{tikzpicture}[
  grow via three points={one child at (0.5,-1) and
  two children at (0.5,-1) and (0.5,-1.7)},
  edge from parent path={(\tikzparentnode.south) |- (\tikzchildnode.west)},
  remember picture, overlay, % r.p. save picture size in the picture, o. puts picture out of text segm.
  inner sep = 0pt, outer sep = 0pt
]

%%% nodes %%%
%% input
% TODO coordinates (-3,4) is strange. Also rectangle around current page seems wrong
\node[text=red] (io) [io, align = left] at (-3,4) {Table of Chemicals \\ CAS, Compound name}; % coordinates: (current page.east)


% \draw[thick] (current page.south west) rectangle (current page.north east); % debuging

%% chemicals
% id nodes
\node (cas) [ids, below of=io, yshift = -4cm] {CAS};
% main nodes
\node (chemprop) [main, dashed, right of=cas, xshift=4.5cm, yshift=3cm] {CHEMPROP};
\node (epa) [main, right of=cas, yshift=1cm, xshift=4.5cm] {EPA ectox tests}
	child { node { qu\_epa.R} };
\node (chemscr) [main, right of=cas, yshift=-1cm, xshift=4.5cm] {Chemical scripts ch}
	child { node { Alan Wood Pesticide Compendium - \textbf{qu\_aw.R } }}
	child { node { Pesticide Action Network - \textbf{ch\_pp.R} }}
	child { node { PhysProp - \textbf{ch\_pp.R} }}
	child { node { PubChem - \textbf{qu\_pubchem.R} }};
% result nodes
\node (toxres) [resvariables, right of=cas, yshift=0cm, xshift=16cm, align = left] {Results\\Test results\\Substance type:\\pesticides, metals, etc.}; % result
%\includegraphics{/home/andreas/Documents/Projects/etox-base/data/pubchemlogo2017.png};

%\animategraphics{https://cfpub.epa.gov/ecotox/epafiles/images/logo_epaseal.gif}

%% organisms
% id nodes
\node (taxon) [ids, below of=cas, yshift=-9cm, align = center] {Taxon}; % \\ {(Genus or Species)}}; % escape brackets usin curly brackets
% main nodes
\node (taxonquery) [main, right of=taxon, xshift=4.5cm, yshift=3cm] {Taxonomic data};
\node (habitat) [main, right of=taxon, xshift=4.5cm, yshift=1cm] {Habitat data}
	child { node { WORMS data base - \textbf{tx\_worms.R} }}
	child { node { Manual Search - \textbf{ha\_manual.R} }};
\node (region) [main, right of = taxon, xshift=4.5cm, yshift=-2cm] {Regional data}
	child { node { GBIF - \textbf{qu\_gbif.R} }};
% result nodes
\node (taxres) [resvariables, right of=taxon, xshift=17cm, align = left] {Results:\\Validation of taxonomic ranks\\Habitat information\\Marine, Bracksih, Freshwater, Terrestrial, Parasites\\Occurrence}; % result

%% final result
\node (testres) [res] at (16,-5) {Final result}
	child { node { re\_merge.R} };
\iffalse
node[anchor = south]
node[anchor = east]
\fi

%%% arrows %%%
\begin{pgfonlayer}{bg1}
\draw [arrow, black] (io) -- (cas);
\draw [arrow, dashed] (cas) -- (chemprop);
\draw [arrow] (cas) -- (chemscr);
\draw [arrow] (cas) -- (epa);
\draw [arrow] (epa) -- (toxres);
\draw [arrow] (chemscr) -- (toxres);

%\begin{scope}[on background layer]
\begin{pgfonlayer}{bg2}
	\draw [arrow, black] (epa) .. controls (-2,-4) and (1,-4) .. (taxon);
\end{pgfonlayer}
%\end{scope}

\draw [arrow] (taxon) -- (habitat);
\draw [arrow] (taxon) -- (region);
\draw [arrow] (taxon) -- (taxonquery);
\draw [arrow] (habitat) -- (taxres);
\draw [arrow] (taxonquery) -- (taxres);
\draw [arrow] (region) -- (taxres);
\draw [arrow] (toxres) -- (testres);
\draw [arrow] (taxres) -- (testres);

\draw [arrow, dashed] (testres) -- (20,-5);
\end{pgfonlayer}


\end{tikzpicture}
\hfill
\vfill
\end{landscape}


%\clearpage


\begin{landscape}
\begin{tikzpicture}

%% entities
\node (clean) [res] at (-5,5) {Cleaning}
	child { node { re\_clean.R} };
\node (filter) [res, right of = clean, xshift = 3cm] {Filter}
	child { node { re\_filter.R} };
\node (plot) [res, right of = filter, xshift = 3cm] {Plots}
	child { node { re\_plot.R} };
\node (agg1) [res, right of = plot, xshift = 3cm] {Aggregation};

\node (write) [io, right of = agg1, xshift = 3cm, yshift = -5cm] {Write tables to data base};

%% cleaning and filter steps
\node (solub) [steps, below of = clean, yshift = -2cm] {Solubility check};
\node (substtype) [steps, below of = solub, yshift = -2cm] {Substance-type: F, AI, U, T};

\node (habitat) [steps, right of = solub, xshift = 7cm] {Habitat: Marine, Brackish, Freshwater, Terrestrial};
\node (region) [steps, right of = solub, xshift = 7cm, yshift = -2cm] {Regions: Americas, Africa, Freshwater, Terrestrial};
\node (duration) [steps, right of = solub, xshift = 7cm, yshift = -4cm] {Tests between 22 and 338h};
\node (taxagroups) [steps, right of = solub, xshift = 7cm, yshift = -6cm] {};

\node (agg1) [steps, right of = solub, xshift = 7cm, yshift = -6cm] {by casnr, taxon and duration};

%% arrows
\draw [->, dashed] (-5,8) -- (clean);

%% boxes
\draw [dashed] (1,6) rectangle (3,-11);
\draw [dashed] (4,5) rectangle (7,-11);
\draw [dashed] (9,5) rectangle (11,-11);
\draw [dashed] (14,5) rectangle (15,-11);


\end{tikzpicture}
\end{landscape}



\end{document}